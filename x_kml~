#!/usr/bin/perl

use Math::Trig;

my $lon1, $lat1, $lon2, $lat2;
my $name, $altitude, $coordinates, @coordinates;
my $z1, $z2, $altitude1;

my $altitude0 = 3344.0;

while(<>) {

   if(m/\<name\>([^\<]+)\<\/name\>/) {
      $name = $1;
   }

   if(m/\<altitude\>([^\<]+)\<\/altitude\>/) {
      $altitude1 = $1;
   }

   if(m/\<longitude\>([^\<]+)\<\/longitude\>/) {
      $longitude = $1;
   }

   if(m/\<latitude\>([^\<]+)\<\/latitude\>/) {
      $latitude = $1;
   }

   if(m/\<coordinates\>/) {
      $coordinates = <>;
      $coordinates =~ s/^\s+//;

      @coordinates = split(/[, ]+/, $coordinates);
      $coordinates = join(", ", @coordinates);

      push(@coordinates($longitude);
      push(@coordinates($latitude);

      if($#coordinates > 3) {

	 $path_length = 0.0;

	 while($#coordinates > 3) {
	    $lon1 = shift(@coordinates);
	    $lat1 = shift(@coordinates);
	    $z1 = shift(@coordinates);

	    $lon2 = $coordinates[0];
	    $lat2 = $coordinates[1];
	    $z2 = $coordinates[2];

	    if($lon1 && $lon2 && $lat1 && $lat2) {

	       $theta = $lon1 - $lon2;

	       $l = sin(deg2rad($lat1)) *
		   sin(deg2rad($lat2)) +
		   cos(deg2rad($lat1)) *
		   cos(deg2rad($lat2)) *
		   cos(deg2rad($theta));

	       $l = acos($l);
	       $l = rad2deg($l);
	       $l = $l * 60 * 1.1515;

	       $l = $l * 1000.0 / 0.62137;

	       $path_length += $l;
	    }

	 }
	 $h = $altitude1 - $altitude0;
	 print "H=$h\n";

	 $p = sqrt($path_length**2 + $h**2);

	 print("$p = sqrt($path_length**2 + $h**2\n");

	 $path_length = sqrt($path_length**2 + $h**2);

	 $altitude0 = $altitude1;

	 print "$name, $lon1,$lat1 $lon2,$lat2 = $path_length\n";
      }
   }
}
